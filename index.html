<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- å¼€å¯ iOS Web App å…¨å±æ¨¡å¼ -->
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- è®¾ç½®çŠ¶æ€æ é¢œè‰² (å¯é€‰: black, default, black-translucent) -->
    <!-- é…åˆä½ çš„é»‘è‰²ç¬”è®°é£æ ¼ï¼Œblack-translucent æ•ˆæœæœ€å¥½ -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- è®¾ç½®æ·»åŠ åˆ°ä¸»å±å¹•åçš„æ ‡é¢˜ -->
    <meta name="apple-mobile-web-app-title" content="SRiPhone">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRiPhone</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- å…¨å±€å˜é‡ --- */
        :root {
            --bg-color: #050505;
            --phone-case: #0a0a0a;
            --phone-border: #222222;
            --screen-bg: #000000;
            --paper-dark: #111111;
            --paper-light: #1a1a1a;
            --text-main: #d0d0d0;
            --text-dim: #555555;
            --border-color: #333333;
            --shadow-color: rgba(0,0,0,0.8);
            --input-bg: #080808;
            --btn-bg: #222;
            --btn-hover: #333;
            --error-bg: #800;
            --error-text: #fff;
            --main-font: 'Courier New', Courier, monospace;
            --app-header-bg: rgba(17, 17, 17, 0.95);
        }

        body.light-mode {
            --bg-color: #e0e0e0;
            --phone-case: #ffffff;
            --phone-border: #000000;
            --screen-bg: #ffffff;
            --paper-dark: #f4f4f4;
            --paper-light: #ffffff;
            --text-main: #000000;
            --text-dim: #333333;
            --border-color: #000000;
            --shadow-color: rgba(0,0,0,0.2);
            --input-bg: #fff;
            --btn-bg: #f0f0f0;
            --btn-hover: #e0e0e0;
            --error-bg: #ff3333;
            --app-header-bg: rgba(244, 244, 244, 0.95);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.4s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; 
        }

        body {
            margin: 0; padding: 0; height: 100vh; display: flex; justify-content: center; align-items: center;
            background-color: var(--bg-color); font-family: var(--main-font); color: var(--text-main); overflow: hidden;
        }

        .phone-container {
            width: 380px; height: 770px; background-color: var(--phone-case); border-radius: 42px; padding: 8px;
            box-shadow: 0 0 0 2px #000, 0 20px 50px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.05);
            position: relative; display: flex; flex-direction: column; border: 4px solid var(--phone-border);
        }
        /* å±å¹•å®¹å™¨ */
        .screen { 
            background-color: var(--screen-bg); border-radius: 30px; flex: 1; 
            position: relative; overflow: hidden; 
            border: 2px solid var(--border-color); box-shadow: inset 0 0 30px rgba(0,0,0,0.05); 
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"); 
        }
        
        /* è§†å›¾åˆ‡æ¢å±‚ */
        .view-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1), opacity 0.4s ease;
            will-change: transform, opacity;
            background-color: var(--screen-bg);
        }

        /* æ¡Œé¢ */
        #desktop-view { z-index: 10; transform: scale(1); opacity: 1; }
        #desktop-view.hidden { transform: scale(0.9); opacity: 0; pointer-events: none; }

        /* å…¨å±åº”ç”¨ */
        #app-view { z-index: 20; transform: scale(1.1); opacity: 0; pointer-events: none; background-color: var(--paper-dark); }
        #app-view.active { transform: scale(1); opacity: 1; pointer-events: all; }

        /* åº”ç”¨å¯¼èˆªæ  */
        /* --- index.html çš„ <style> ä¸­ --- */

            .app-navbar {
            height: 45px;  /* ä¿®æ”¹è¿™é‡Œï¼šåŸ 60px -> 45px */
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-bottom: 2px solid var(--border-color); 
            padding: 0 15px;
            background: var(--app-header-bg); 
            backdrop-filter: blur(5px);
            position: relative; 
            flex-shrink: 0; 
            z-index: 5;
        }

        .back-btn { 
            position: absolute; 
            left: 10px;
            font-size: 1rem;
            cursor: pointer; 
            color: var(--text-main); 
            width: 30px;
            height: 30px;
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        
        .app-title { 
            font-weight: bold; 
            font-size: 0.9rem;
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }
        .app-content-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .app-placeholder { color: var(--text-dim); font-style: italic; text-align: center; margin-top: 50px; }

        /* æ¡Œé¢ç»„ä»¶ */
        .header-widget { text-align: center; padding: 55px 20px 10px; position: relative; flex-shrink: 0; }
        .clock-card { background-color: var(--paper-dark); padding: 10px 30px; border: 3px dashed var(--border-color); display: inline-block; transform: rotate(1deg); box-shadow: 3px 3px 0px var(--shadow-color); border-radius: 4px; }
        .time { font-size: 2.5rem; font-weight: bold; letter-spacing: 2px; color: var(--text-main); }
        .date { font-size: 0.9rem; color: var(--text-dim); margin-top: 5px; border-top: 1px solid var(--border-color); padding-top: 5px; font-weight: bold; }

        /* --- ä¿®æ”¹å¼€å§‹ï¼šé‚®ç¥¨é£æ ¼å›¾æ ‡ & ç¼–è¾‘æ¨¡å¼ --- */
        
        /* 1. ç¼–è¾‘æ§åˆ¶æ  - ç§»è‡³å±å¹•åº•ç«¯ */
        .edit-controls {
            position: fixed;
            bottom: 0; left: 50%; transform: translateX(-50%);
            display: flex; justify-content: center; gap: 12px; align-items: center;
            z-index: 100;
            opacity: 0; pointer-events: none; transform: translateX(-50%) scale(0.9);
            transition: 0.3s ease;
            background: rgba(0, 0, 0, 0.7); 
            padding: 5px 8px; border-radius: 20px 20px 0 0;
            backdrop-filter: blur(8px);
        }
        .edit-controls.active { 
            opacity: 1; pointer-events: all; transform: translateX(-50%) scale(1);
        }
        .edit-btn {
            width: 30px; height: 30px; border-radius: 50%;
            border: 1.5px solid #fff; color: #fff;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.95rem; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            background: #222; transition: 0.2s;
            flex-shrink: 0;
        }
        .edit-btn:active { transform: scale(0.95); }
        .edit-btn.save { background: #5cc976; border-color: #28a745; }
        .edit-btn.cancel { background: #d4747e; border-color: #dc3545; }
        .edit-btn.reset { background: #4a90e2; border-color: #2e5c99; }

        /* ç¼–è¾‘æ¨¡å¼ä¸‹çš„æ ·å¼è°ƒæ•´ */
        body.is-editing .app-item { transform: scale(0.93); opacity: 0.85; }
        body.is-editing .header-widget { opacity: 0.5; }
        
        /* ç§»åŠ¨ç«¯ç¼–è¾‘æ§åˆ¶æ é€‚é… */
        @media (max-width: 480px) {
            .edit-controls {
                bottom: 85px; gap: 8px; padding: 6px 10px;
            }
            .edit-btn {
                width: 32px; height: 32px; font-size: 0.8rem;
                border-width: 1px;
            }
        }

        /* 2. é‚®ç¥¨/è´´çº¸é£æ ¼ APP å›¾æ ‡ */
        .app-grid { 
            flex: 1; display: grid; grid-template-columns: repeat(2, 1fr); 
            gap: 20px; padding: 20px 30px; /* å¢åŠ é—´è· */
            overflow-y: auto; align-content: start; 
            /* å…³é”®ï¼šé˜²æ­¢é•¿æŒ‰é€‰ä¸­æ–‡å­— */
            user-select: none; 
        }
        .app-grid::-webkit-scrollbar { width: 0; }

        .app-item { 
            /* --- æ ¸å¿ƒä¿®æ”¹ï¼šé‚®ç¥¨å½¢çŠ¶ --- */
            
            /* 1. è®¾ç½®è¾¹æ¡†å®½åº¦ï¼Œè¿™é‡Œå°±æ˜¯"é½¿å­”"åŒºåŸŸçš„å®½åº¦ */
            border: 5px solid transparent;
            
            /* 2. èƒŒæ™¯é­”æ³•ï¼šåŒå±‚èƒŒæ™¯ */
            background-image: 
                /* ä¸Šå±‚ï¼šå®å¿ƒèƒŒæ™¯ï¼Œç›–ä½ä¸­é—´çš„å†…å®¹ */
                linear-gradient(var(--paper-light), var(--paper-light)),
                /* ä¸‹å±‚ï¼šå…¨æ˜¯å­”çš„èƒŒæ™¯ï¼ˆå¾„å‘æ¸å˜ï¼‰ */
                radial-gradient(circle, transparent 4px, var(--paper-light) 4.5px);
            
            /* 3. èƒŒæ™¯è£å‰ªï¼šä¸Šå±‚åªæ˜¾ç¤ºåœ¨å†…å®¹åŒºï¼Œä¸‹å±‚æ˜¾ç¤ºåœ¨è¾¹æ¡†åŒº */
            background-clip: padding-box, border-box;
            background-origin: padding-box, border-box;
            
            /* 4. é½¿å­”çš„å¤§å°å’Œæ’åˆ— */
            background-size: 100% 100%, 15px 15px; /* 15pxæ˜¯æ¯ä¸ªå­”çš„é—´è· */
            background-repeat: no-repeat, round;   /* round ä¼šè‡ªåŠ¨è°ƒæ•´é—´è·ä¿è¯å­”æ˜¯å®Œæ•´çš„ */
            
            /* --- å…¶ä»–æ ·å¼ --- */
            height: 85px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            cursor: pointer; position: relative; 
            transition: transform 0.2s; 
            
            /* å…³é”®ï¼šå› ä¸ºå½¢çŠ¶ä¸è§„åˆ™ï¼ŒåŸæ¥çš„ box-shadow ä¼šæ˜¯ä¸ªæ–¹å—ï¼Œå¾ˆéš¾çœ‹ */
            /* æ”¹ç”¨ filter: drop-shadowï¼Œå®ƒèƒ½å®Œç¾è´´åˆé‚®ç¥¨çš„é½¿å­”è¾¹ç¼˜ */
            box-shadow: none;
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.2));
            
            /* ç¨å¾®è°ƒæ•´åœ†è§’ï¼Œè®©å››ä¸ªè§’çš„é½¿å­”è‡ªç„¶ä¸€ç‚¹ */
            border-radius: 4px; 
        }

        /* éšæœºæ—‹è½¬æ•ˆæœ (ä¿ç•™åŸå‘³) */
        .app-item:nth-child(odd) { transform: rotate(-2deg); }
        .app-item:nth-child(even) { transform: rotate(2deg); }
        .app-item:nth-child(3n) { transform: rotate(1deg); }

        /* æ‚¬åœæ•ˆæœ */
        .app-item:hover { 
            transform: scale(1.05) rotate(0deg) !important; 
            z-index: 10; 
            border-color: var(--text-main); 
            border-style: solid; /* æ‚¬åœæ—¶å˜å®çº¿ */
            /* æ‚¬åœæ—¶èƒŒæ™¯å˜æ·±ä¸€ç‚¹ */
            background-image: 
                linear-gradient(var(--paper-dark), var(--paper-dark)),
                radial-gradient(circle, transparent 4px, var(--paper-dark) 4.5px);
        }
        
        .app-icon { font-size: 1.8rem; margin-bottom: 8px; color: var(--text-dim); transition: color 0.3s; }
        .app-item:hover .app-icon { color: var(--text-main); }
        .app-name { font-size: 0.75rem; color: var(--text-dim); font-weight: bold; font-family: 'Courier New', Courier, monospace; letter-spacing: -0.5px; }
        .app-item:hover .app-name { color: var(--text-main); }
        
        /* ç¼–è¾‘æ¨¡å¼ä¸‹çš„æ ·å¼è°ƒæ•´ */
        @keyframes jiggle {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-2px) rotate(-1deg); }
            75% { transform: translateX(2px) rotate(1deg); }
        }
        .app-item.editing {
            animation: jiggle 0.25s infinite ease-in-out;
            cursor: grab;
            z-index: 50;
            /* ç¼–è¾‘æ¨¡å¼ä¹Ÿç”¨æ·±è‰²èƒŒæ™¯ï¼Œæ˜¾çœ¼ä¸€ç‚¹ */
            background-image: 
                linear-gradient(var(--paper-dark), var(--paper-dark)),
                radial-gradient(circle, transparent 4px, var(--paper-dark) 4.5px);
        }
        
        /* æ‹–æ‹½æ—¶çš„æ ·å¼ */
        .app-item.dragging {
            opacity: 0.5;
            filter: drop-shadow(0 0 0 rgba(0,0,0,0)); /* æ‹–æ‹½æ—¶å»æ‰é˜´å½±ä¼˜åŒ–æ€§èƒ½ */
        }

        /* åº•éƒ¨ Dock */
        .dock-bar { height: 75px; background-color: var(--bg-color); border-top: 2px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; padding: 8px 10px 0 10px; z-index: 30; border-radius: 0 0 35px 35px; }
        .dock-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; opacity: 0.8; transition: 0.2s; width: 60px; }
        .dock-item:hover { opacity: 1; transform: translateY(-3px); }
        .dock-icon-box { width: 45px; height: 45px; background-color: var(--paper-dark); border: 1px solid var(--border-color); border-radius: 12px; display: flex; justify-content: center; align-items: center; margin-bottom: 5px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); color: var(--text-main); }
        .dock-text { font-size: 0.6rem; transform: scale(0.9); font-weight: bold; color: var(--text-dim); }

        /* æ¨¡æ€æ¡† */
        .error-toast { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); background-color: var(--error-bg); color: var(--error-text); padding: 10px 20px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 200; transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 8px; z-index: 10002; border: 2px solid #fff; }
        .error-toast.show { top: 20px; }

        /* ç»Ÿä¸€é€šçŸ¥ç³»ç»Ÿ */
        #info-notification { 
            position: fixed; top: -80px; left: 50%; transform: translateX(-50%); 
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.95));
            color: #7897cc; padding: 12px 22px; border-radius: 8px; 
            font-size: 0.85rem; font-weight: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.35);
            z-index: 10003; transition: top 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; align-items: center; gap: 10px; 
            backdrop-filter: blur(10px); border: 3px solid rgba(104, 104, 104, 0.2);
            max-width: 90%;
        }
        #info-notification.show { top: 15px; }
        #info-notification.error { 
            background: linear-gradient(135deg, rgba(255, 80, 80, 0.95), rgba(255, 60, 60, 0.95));
        }
        #info-notification.warning { 
            background: linear-gradient(135deg, rgba(255, 150, 80, 0.95), rgba(255, 130, 60, 0.95));
        }
        #info-notification.success { 
            background: linear-gradient(135deg, rgba(80, 200, 120, 0.95), rgba(60, 180, 100, 0.95));
        }
        #info-notification i { font-size: 1rem; }

        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 50; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content { width: 85%; background-color: var(--paper-dark); border: 2px solid var(--border-color); padding: 20px; position: relative; transform: rotate(-1deg); box-shadow: 5px 5px 0px rgba(0,0,0,0.5); border-radius: 5px; color: var(--text-main); }
        .scrollable-content { max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .scrollable-content::-webkit-scrollbar { width: 4px; }
        .scrollable-content::-webkit-scrollbar-thumb { background: var(--border-color); }
        .modal-title { text-align: center; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .close-modal { position: absolute; top: -15px; right: -10px; background: #000; color: #fff; width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 2px solid #fff; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 101; }
        body.light-mode .close-modal { background: #fff; color: #000; border: 2px solid #000; }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: var(--text-dim); font-weight: bold; }
        .input-field { width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px; font-family: inherit; outline: none; border-radius: 3px; }
        .btn { background: var(--btn-bg); color: var(--text-main); border: 1px solid var(--border-color); padding: 10px 15px; cursor: pointer; font-family: inherit; width: 100%; margin-top: 10px; border-radius: 3px; transition: background 0.2s; font-weight: bold; }
        .btn:hover { background: var(--btn-hover); border-color: var(--text-main); }
        .btn-small { width: auto; padding: 0 10px; margin-top: 0; height: 38px; font-size: 0.8rem; white-space: nowrap; }

        .theme-options { display: flex; gap: 15px; justify-content: center; margin-bottom: 25px; }
        .theme-card { flex: 1; height: 80px; border: 2px solid var(--border-color); border-radius: 5px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.2s; }
        .theme-card.night { background: #000; color: #fff; border-color: #333; }
        .theme-card.day { background: #fff; color: #000; border-color: #000; }
        .section-title { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 10px; border-left: 3px solid var(--text-main); padding-left: 8px; font-weight: bold; }
        .font-manager-inputs { display: flex; gap: 8px; margin-bottom: 10px; }
        .font-list { max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 3px; background: var(--input-bg); }
        .font-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; }
        .font-item.active { background: var(--paper-light); border-left: 3px solid var(--text-main); }
        .delete-font-btn { color: var(--text-dim); padding: 5px 10px; cursor: pointer; }
        /* API è®¾ç½®æ¨¡æ€æ¡†æ ·å¼ */
        .api-presets-section {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .api-preset-input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .api-preset-input-row input {
            flex: 1;
        }
        .api-preset-btn {
            flex: 0 0 auto;
        }
        .api-presets-list {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: var(--input-bg);
            margin-top: 8px;
        }
        .api-preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
        }
        .api-preset-item:hover {
            background: var(--paper-light);
        }
        .api-preset-item.active {
            background: var(--paper-dark);
            border-left: 3px solid #5cc976;
            padding-left: 7px;
            font-weight: bold;
        }
        .api-preset-item:last-child {
            border-bottom: none;
        }
        .api-preset-delete {
            color: #ff5555;
            cursor: pointer;
            padding: 2px 8px;
            font-size: 0.75rem;
            opacity: 0.7;
        }
        .api-preset-delete:hover {
            opacity: 1;
        }
        .api-settings-main {
            display: flex;
            gap: 15px;
        }
        .api-settings-form {
            flex: 1;
        }
        .api-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .api-row .input-group {
            flex: 1;
            margin-bottom: 0;
        }
        .api-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .api-actions button {
            flex: 1;
        }
        .api-preset-name-input {
            flex: 0 0 120px;
        }
        /* --- ç³»ç»Ÿé€šç”¨å¼¹çª— (System Dialog) --- */
        .sys-dialog-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 20000; /* å¿…é¡»æœ€é«˜ */
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
            backdrop-filter: blur(3px);
        }
        .sys-dialog-overlay.active { opacity: 1; pointer-events: all; }

        .sys-dialog-box {
            width: 80%; background: var(--paper-dark);
            border: 2px solid var(--text-main); border-radius: 15px;
            padding: 20px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: scale(0.9); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .sys-dialog-overlay.active .sys-dialog-box { transform: scale(1); }

        .sys-dialog-title {
            font-size: 1.1rem; font-weight: bold 10px; margin-bottom: 10px;
            text-transform: uppercase; letter-spacing: 1px; color: var(--text-main);
        }
        .sys-dialog-msg {
            font-size: 0.9rem; color: var(--text-dim); margin-bottom: 20px; line-height: 1.4;
        }

        .sys-dialog-btns { display: flex; gap: 10px; justify-content: center; }
        .sys-btn {
            flex: 1; padding: 10px; border: 1px solid var(--border-color);
            background: transparent; color: var(--text-main); border-radius: 8px;
            cursor: pointer; font-family: inherit; font-weight: bold; font-size: 0.85rem;
            transition: 0.2s;
        }
        .sys-btn:hover { background: var(--text-main); color: var(--bg-color); }
        .sys-btn.danger { border-color: #a00; color: #a00; }
        .sys-btn.danger:hover { background: #a00; color: #fff; }
    
    </style>
</head>
<body>

    <style id="custom-font-styles"></style>

    <div class="phone-container">
        <div class="screen">
            <div id="error-toast" class="error-toast"><i class="fas fa-exclamation-triangle"></i><span id="error-msg">è¿æ¥å¤±è´¥</span></div>
            <div id="info-notification"><i class="fas fa-info-circle"></i><span id="info-text">ä¿¡æ¯</span></div>

            <!-- éŸ³ä¹åˆ—è¡¨å¼¹çª— -->
            <div class="music-modal" id="music-modal">
                <div class="input-group">
                    <input type="text" id="add-music-name" class="music-input" placeholder="Name">
                    <input type="text" id="add-music-artist" class="music-input" placeholder="Artist">
                </div>
                <div class="input-group">
                    <input type="text" id="add-music-url" class="music-input" placeholder="MP3 URL">
                </div>
                <div class="input-group">
                    <input type="text" id="add-music-cover" class="music-input" placeholder="Cover URL">
                    <button class="music-input" style="width:40px; cursor:pointer;" onclick="addMusic()">+</button>
                </div>
                <div class="song-list" id="playlist-container">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>
                        
            <!-- 1. æ¡Œé¢è§†å›¾ -->
            <div id="desktop-view" class="view-layer">
                
                <!-- æ–°å¢ï¼šç¼–è¾‘æ¨¡å¼æ§åˆ¶æ  - å±å¹•åº•éƒ¨ -->
                <div class="edit-controls" id="edit-controls">
                    <div class="edit-btn cancel" onclick="cancelEditMode()" title="å–æ¶ˆ"><i class="fas fa-times"></i></div>
                    <div class="edit-btn reset" onclick="resetDesktopLayout()" title="é‡ç½®"><i class="fas fa-redo"></i></div>
                    <div class="edit-btn save" onclick="saveEditMode()" title="ä¿å­˜"><i class="fas fa-check"></i></div>
                </div>

                <div class="header-widget">
                    <div class="clock-card"><div class="time" id="clock-time">00:00</div><div class="date" id="clock-date">2024.01.01 MON</div></div>
                </div>
                
                <!-- ç»™ grid æ·»åŠ äº† id="app-grid-container" -->
                <div class="app-grid" id="app-grid-container">
                    <!-- æ³¨æ„ï¼šè¿™é‡Œå»æ‰äº† onclickï¼Œæ”¹ç”¨ JS åŠ¨æ€ç»‘å®šï¼Œä¸ºäº†é˜²æ­¢ç¼–è¾‘æ—¶è¯¯è§¦ -->
                    <!-- ä½†ä¸ºäº†å…¼å®¹ä½ çš„æ—§ä»£ç ï¼Œæˆ‘ä»¬å…ˆä¿æŒ onclickï¼Œåœ¨ JS é‡Œæ‹¦æˆª -->
                    
                    <!-- ä½ çš„åº”ç”¨åˆ—è¡¨ (ä¿æŒåŸæ ·ï¼Œæˆ–è€…ä½ å¯ä»¥æ‰‹åŠ¨è°ƒæ•´é¡ºåº) -->
                    <div class="app-item" data-app="Whatsapp"><i class="fab fa-whatsapp app-icon"></i><span class="app-name">Whatsapp</span></div>
                    <div class="app-item" data-app="è´´å§"><i class="fas fa-layer-group app-icon"></i><span class="app-name">è´´å§</span></div>
                    <div class="app-item" data-app="è´­ç‰©"><i class="fas fa-shopping-bag app-icon"></i><span class="app-name">è´­ç‰©</span></div>
                    <div class="app-item" data-app="ç›´æ’­"><i class="fas fa-video app-icon"></i><span class="app-name">ç›´æ’­</span></div>
                    <div class="app-item" data-app="å°æ¸¸æˆ"><i class="fas fa-gamepad app-icon"></i><span class="app-name">å°æ¸¸æˆ</span></div>
                    <div class="app-item" data-app="å°å‰§åœº"><i class="fas fa-theater-masks app-icon"></i><span class="app-name">å°å‰§åœº</span></div>
                    <div class="app-item" data-app="çº¦ä¼š"><i class="fas fa-calendar-check app-icon"></i><span class="app-name">çº¦ä¼š</span></div>
                    <div class="app-item" data-app="è§’è‰²æ‰‹æœº"><i class="fas fa-mobile-alt app-icon"></i><span class="app-name">è§’è‰²æ‰‹æœº</span></div>
                </div>
            </div>

            <!-- 2. å…¨å±åº”ç”¨è§†å›¾ -->
            <div id="app-view" class="view-layer">
                <div class="app-navbar">
                    <div class="back-btn" onclick="closeApp()"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" id="active-app-title">åº”ç”¨åç§°</div>
                </div>
                <!-- è¿™é‡Œæ”¹æˆäº† iframe -->
                <div class="app-content-container" style="padding: 0; overflow: hidden;">
                    <iframe id="app-frame" src="" frameborder="0" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨ Dock -->
        <div class="dock-bar">
            <div class="dock-item" onclick="openApp('è§’è‰²è®¾å®š')"><div class="dock-icon-box" style="transform: rotate(-3deg);"><i class="fas fa-user-tag"></i></div><span class="dock-text">è®¾å®š</span></div>
            <div class="dock-item" onclick="openApp('ä¸–ç•Œä¹¦')"><div class="dock-icon-box" style="transform: rotate(2deg);"><i class="fas fa-book-journal-whills"></i></div><span class="dock-text">ä¸–ç•Œä¹¦</span></div>
            <div class="dock-item" onclick="openSettings('appearance')"><div class="dock-icon-box" style="transform: rotate(-1deg);"><i class="fas fa-paint-brush"></i></div><span class="dock-text">å¤–è§‚</span></div>
            <div class="dock-item" onclick="openSettings('api')"><div class="dock-icon-box" style="transform: rotate(3deg); border-color: var(--text-dim);"><i class="fas fa-key"></i></div><span class="dock-text">API</span></div>
        </div>

        <!-- API è®¾ç½®æ¨¡æ€æ¡† -->
        <div id="api-modal" class="modal">
            <div class="modal-content">
                <div class="close-modal" onclick="closeModal('api-modal')">Ã—</div>
                <div class="scrollable-content">
                    <h3 class="modal-title">API setting</h3>
                    
                    <!-- é¢„è®¾ç®¡ç†åŒºåŸŸ -->
                    <div class="api-presets-section">
                        <div class="section-title">API é¢„è®¾ç®¡ç†</div>
                        <div class="api-preset-input-row">
                            <input type="text" id="api-preset-name" class="input-field api-preset-name-input" placeholder="é¢„è®¾å">
                            <button class="btn btn-small api-preset-btn" onclick="saveApiPreset()"><i class="fas fa-save"></i> ä¿å­˜é¢„è®¾</button>
                        </div>
                        <div class="api-presets-list" id="api-presets-list"></div>
                    </div>
                    
                    <!-- API è¿æ¥è®¾ç½®åŒºåŸŸ -->
                    <div class="section-title">è¿æ¥ä¿¡æ¯</div>
                    <div class="input-group"><label>API Endpoint</label><input type="text" id="api-url" class="input-field" placeholder="https://api.openai.com/v1"></div>
                    <div class="input-group"><label>API Key</label><input type="password" id="api-key" class="input-field" placeholder="sk-..."></div>
                    <div class="api-row">
                        <div class="input-group">
                            <label>Model</label>
                            <select id="api-model" class="input-field"></select>
                        </div>
                        <button class="btn btn-small" onclick="fetchModels()"><i class="fas fa-sync-alt"></i> è·å–æ¨¡å‹</button>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="api-actions">
                        <button class="btn" onclick="saveApiSettings()"><i class="fas fa-check"></i> ä¿å­˜è®¾ç½®</button>
                    </div>
                    <p id="save-msg" style="text-align: center; font-size: 0.7rem; margin-top: 10px; color: var(--text-dim); height: 1rem;"></p>
                </div>
            </div>
        </div>

        <!-- å¤–è§‚è®¾ç½®æ¨¡æ€æ¡† -->
        <div id="appearance-modal" class="modal">
            <div class="modal-content">
                <div class="close-modal" onclick="closeModal('appearance-modal')">Ã—</div>
                <div class="scrollable-content">
                    <h3 class="modal-title">å¤–è§‚é£æ ¼</h3>
                    <div class="theme-options">
                        <div class="theme-card night" onclick="setTheme('dark')"><i class="fas fa-moon"></i><span>çº¯é»‘å¤œé—´</span></div>
                        <div class="theme-card day" onclick="setTheme('light')"><i class="fas fa-sun"></i><span>é«˜äº®æ—¥é—´</span></div>
                    </div>
                    <div class="section-title">ç³»ç»Ÿå­—ä½“ (Fonts)</div>
                    <div class="font-manager-inputs">
                        <input type="text" id="new-font-name" class="input-field" placeholder="å­—ä½“åç§°" style="width: 40%;">
                        <input type="text" id="new-font-url" class="input-field" placeholder="å­—ä½“URL" style="width: 60%;">
                    </div>
                    <button class="btn" onclick="addCustomFont()" style="margin-top: 0; margin-bottom: 15px;"><i class="fas fa-plus"></i> å¯¼å…¥å¹¶ä¿å­˜</button>
                    <div class="font-list" id="font-list-container"></div>
                </div>
            </div>
        </div>
        <!-- ç³»ç»Ÿé€šç”¨å¼¹çª— -->
        <div class="sys-dialog-overlay" id="sys-dialog">
            <div class="sys-dialog-box">
                <div class="sys-dialog-title" id="sys-title">SYSTEM ALERT</div>
                <div class="sys-dialog-msg" id="sys-msg">Are you sure?</div>
                <div class="sys-dialog-btns">
                    <button class="sys-btn" id="sys-btn-cancel" onclick="closeSysDialog()">CANCEL</button>
                    <button class="sys-btn danger" id="sys-btn-confirm">CONFIRM</button>
                </div>
            </div>
        </div>
    
    </div>

    <script>
        // --- å…¨å±€ç³»ç»Ÿå¼¹çª—é€»è¾‘ ---
        let confirmCallback = null;

        /**
         * æ˜¾ç¤ºç¡®è®¤å¼¹çª—
         * @param {string} msg - æç¤ºæ¶ˆæ¯
         * @param {function} onConfirm - ç‚¹å‡»ç¡®è®¤åçš„å›è°ƒå‡½æ•°
         * @param {string} title - (å¯é€‰) æ ‡é¢˜
         * @param {boolean} isDanger - (å¯é€‰) æ˜¯å¦ä¸ºå±é™©æ“ä½œ(çº¢è‰²æŒ‰é’®)
         */
        window.showConfirm = function(msg, onConfirm, title = "CONFIRMATION", isDanger = true) {
            const dialog = document.getElementById('sys-dialog');
            document.getElementById('sys-title').textContent = title;
            document.getElementById('sys-msg').textContent = msg;
            
            const confirmBtn = document.getElementById('sys-btn-confirm');
            
            // è®¾ç½®æ ·å¼
            if(isDanger) {
                confirmBtn.classList.add('danger');
                confirmBtn.textContent = "ofcğŸ—";
            } else {
                confirmBtn.classList.remove('danger');
                confirmBtn.textContent = "OK";
            }

            // å­˜å‚¨å›è°ƒ
            confirmCallback = onConfirm;
            
            dialog.classList.add('active');
        };

        // ç»‘å®šç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('sys-btn-confirm').addEventListener('click', function() {
            if (confirmCallback) confirmCallback();
            closeSysDialog();
        });

        window.closeSysDialog = function() {
            document.getElementById('sys-dialog').classList.remove('active');
            confirmCallback = null;
        };
        
        // --- åº”ç”¨é…ç½®è¡¨ï¼šåå­—å¯¹åº”æ–‡ä»¶å ---
        const appRoutes = {
            'Whatsapp': 'apps/whatsapp/whatsapp.html',
            'è´´å§': 'apps/tieba.html',
            'è´­ç‰©': 'apps/shopping.html',
            'ç›´æ’­': 'apps/live.html',
            'å°æ¸¸æˆ': 'apps/game.html',
            'å°å‰§åœº': 'apps/theater.html',
            'çº¦ä¼š': 'apps/date.html',
            'è§’è‰²æ‰‹æœº': 'apps/phone.html',
            'è§’è‰²è®¾å®š': 'apps/settings.html',
            'ä¸–ç•Œä¹¦': 'apps/worldbook.html'
        };

        // æ‰“å¼€åº”ç”¨
        function openApp(appName) {
            const desktop = document.getElementById('desktop-view');
            const appView = document.getElementById('app-view');
            const title = document.getElementById('active-app-title');
            const iframe = document.getElementById('app-frame');

            // 1. è®¾ç½®æ ‡é¢˜
            title.textContent = appName;

            // 2. åŠ è½½å¯¹åº”çš„ HTML æ–‡ä»¶
            if (appRoutes[appName]) {
                iframe.src = appRoutes[appName];
            } else {
                // å¦‚æœæ–‡ä»¶è¿˜æ²¡åšå¥½ï¼Œå¯ä»¥åŠ è½½ä¸€ä¸ªä¸´æ—¶çš„ 404 é¡µé¢æˆ–è€…ç©ºç™½
                iframe.src = 'about:blank'; 
                console.warn('æœªæ‰¾åˆ°åº”ç”¨æ–‡ä»¶:', appName);
            }

            // 3. æ‰§è¡ŒåŠ¨ç”»
            desktop.classList.add('hidden');
            appView.classList.add('active');
        }

        // å…³é—­åº”ç”¨
        function closeApp() {
            const desktop = document.getElementById('desktop-view');
            const appView = document.getElementById('app-view');
            const iframe = document.getElementById('app-frame');

            // 1. åŠ¨ç”»è¿”å›
            appView.classList.remove('active');
            desktop.classList.remove('hidden');

            // 2. å»¶è¿Ÿæ¸…ç©º iframeï¼Œé¿å…åŠ¨ç”»è¿‡ç¨‹ä¸­ç™½å±ï¼ŒåŒæ—¶èŠ‚çœèµ„æº
            setTimeout(() => {
                iframe.src = 'about:blank';
            }, 400); 
        }

        function openSettings(type) {
            if (type === 'api') {
                document.getElementById('api-url').value = AppStorage.getString('chat_api_url');
                document.getElementById('api-key').value = AppStorage.getString('chat_api_key');
                // åŠ è½½é¢„è®¾åˆ—è¡¨
                if (typeof renderApiPresetsList === 'function') {
                    renderApiPresetsList();
                }
                document.getElementById('api-modal').classList.add('active');
            } else if (type === 'appearance') {
                renderFontList(); // è¿™ä¸ªå‡½æ•°ç°åœ¨æ¥è‡ª settings/appearance.js
                document.getElementById('appearance-modal').classList.add('active');
            }
        }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if(modalId === 'api-modal') document.getElementById('save-msg').textContent = '';
        }

        function updateClock() {
            const now = new Date();
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            document.getElementById('clock-time').textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            document.getElementById('clock-date').textContent = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')} ${days[now.getDay()]}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // ==========================================
        // ç»Ÿä¸€é€šçŸ¥ç³»ç»Ÿ
        // ==========================================
        let notificationTimeout;
        function showInfo(msg, type = 'default') {
            const notification = document.getElementById('info-notification');
            const text = document.getElementById('info-text');
            const icon = notification.querySelector('i');
            
            // å–æ¶ˆä¹‹å‰çš„è¶…æ—¶
            if (notificationTimeout) clearTimeout(notificationTimeout);
            
            // è®¾ç½®å›¾æ ‡å’Œç±»å‹
            notification.className = '';
            if (type === 'error') {
                notification.classList.add('error');
                icon.className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                notification.classList.add('warning');
                icon.className = 'fas fa-exclamation-triangle';
            } else if (type === 'success') {
                notification.classList.add('success');
                icon.className = 'fas fa-check-circle';
            } else {
                icon.className = 'fas fa-info-circle';
            }
            
            text.textContent = msg;
            notification.classList.add('show');
            
            // 3ç§’åè‡ªåŠ¨å…³é—­
            notificationTimeout = setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showError(msg) {
            const toast = document.getElementById('error-toast');
            document.getElementById('error-msg').textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ç»Ÿä¸€çš„ç¡®è®¤å¯¹è¯æ¡†å¤„ç†å‡½æ•°
        window.showConfirmOrAlert = function(message, onConfirm, title = 'ç¡®è®¤') {
            if (typeof window.showConfirm === 'function') {
                // å¦‚æœå·²å®šä¹‰äº† showConfirmï¼Œä½¿ç”¨å®ƒ
                window.showConfirm(message, onConfirm, title);
            } else {
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨åŸç”Ÿ confirm
                if (confirm(message)) {
                    onConfirm();
                }
            }
        };

        // ==========================================
        // æ¡Œé¢å›¾æ ‡ç®¡ç†ç³»ç»Ÿ (é•¿æŒ‰ç¼–è¾‘ & æ‹–æ‹½)
        // ==========================================
        
        const gridContainer = document.getElementById('app-grid-container');
        let isEditMode = false;
        let pressTimer;
        let originalOrderHTML = ''; // ç”¨äºå–æ¶ˆæ—¶æ¢å¤

        // ==========================================
        // å·¥å…·å‡½æ•°ï¼šæå–é‡å¤ä»£ç 
        // ==========================================
        
        // è·å–æ‰€æœ‰åº”ç”¨å›¾æ ‡å…ƒç´ 
        const getAppItems = () => document.querySelectorAll('.app-item');
        
        // ç»Ÿä¸€çš„ Storage Manager - å¤„ç† localStorage å’Œ JSON è½¬æ¢
        const AppStorage = {
            get: (key, defaultValue = null) => {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : defaultValue;
                } catch(e) {
                    console.error(`Storage.get("${key}") error:`, e);
                    return defaultValue;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch(e) {
                    console.error(`Storage.set("${key}") error:`, e);
                }
            },
            remove: (key) => {
                localStorage.removeItem(key);
            },
            getString: (key, defaultValue = '') => localStorage.getItem(key) || defaultValue,
            setString: (key, value) => localStorage.setItem(key, value)
        };

        // 1. åˆå§‹åŒ–ï¼šç»™æ‰€æœ‰å›¾æ ‡ç»‘å®šäº‹ä»¶ & åŠ è½½ä¿å­˜çš„é¡ºåº
        function initDesktopIcons() {
            // å°è¯•åŠ è½½ä¿å­˜çš„é¡ºåº
            const savedOrder = AppStorage.get('desktop_layout');
            if (savedOrder && Array.isArray(savedOrder)) {
                // å¦‚æœæœ‰ä¿å­˜çš„é¡ºåºï¼Œé‡æ–°æ’åˆ— DOM
                const currentItems = Array.from(gridContainer.children);
                const savedApps = savedOrder;
                
                // æ¸…ç©ºå®¹å™¨
                gridContainer.innerHTML = '';
                
                // æŒ‰ä¿å­˜çš„é¡ºåºæ·»åŠ 
                savedApps.forEach(appName => {
                    const item = currentItems.find(el => el.getAttribute('data-app') === appName);
                    if (item) gridContainer.appendChild(item);
                });
                
                // æŠŠæ²¡åœ¨ä¿å­˜åˆ—è¡¨é‡Œçš„æ–° App (å¦‚æœæœ‰çš„è¯) åŠ åˆ°åé¢
                currentItems.forEach(item => {
                    if (!savedApps.includes(item.getAttribute('data-app'))) {
                        gridContainer.appendChild(item);
                    }
                });
            }

            // é‡æ–°ç»‘å®šäº‹ä»¶
            getAppItems().forEach(item => {
                // ç§»é™¤æ—§çš„ onclick (å¦‚æœ HTML é‡Œè¿˜ç•™ç€çš„è¯)
                item.onclick = null; 
                
                // ç»‘å®šäº¤äº’äº‹ä»¶ï¼ˆæ³¨æ„ï¼šè§¦æ‘¸äº‹ä»¶åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ä¼šè¢« handleTouchStart å¤„ç†ï¼‰
                item.addEventListener('mousedown', handlePressStart);
                item.addEventListener('touchstart', handlePressStart, {passive: false});
                
                item.addEventListener('click', handleClick);
                
                // æ‹–æ‹½äº‹ä»¶ (HTML5 Drag API - ä»…æ¡Œé¢ç«¯)
                item.setAttribute('draggable', 'false');
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('drop', handleDrop);
            });
        }

        // 2. äº¤äº’é€»è¾‘ï¼šç‚¹å‡» vs é•¿æŒ‰
        function handlePressStart(e) {
            // ç¼–è¾‘æ¨¡å¼ä¸‹ï¼šæ¡Œé¢ç«¯è®©æ‹–æ‹½å¤„ç†ï¼Œç§»åŠ¨ç«¯é˜»æ­¢äº‹ä»¶ä¼ æ’­
            if (isEditMode) {
                // ç§»åŠ¨ç«¯ï¼šé˜»æ­¢è§¦æ‘¸äº‹ä»¶ä¼ æ’­ï¼Œè®©æ‹–æ‹½äº‹ä»¶å¤„ç†
                if (e.type === 'touchstart') {
                    e.stopPropagation();
                }
                // æ¡Œé¢ç«¯ï¼šä¸é˜»æ­¢ mousedownï¼Œè®© HTML5 Drag & Drop æ­£å¸¸å·¥ä½œ
                return;
            }
            
            // é¼ æ ‡å·¦é”®æˆ–è§¦æ‘¸
            if (e.type === 'mousedown' && e.button !== 0) return;

            pressTimer = setTimeout(() => {
                enterEditMode();
            }, 800); // 800ms é•¿æŒ‰è¿›å…¥ç¼–è¾‘

            const cancelPress = () => clearTimeout(pressTimer);
            e.target.addEventListener('mouseup', cancelPress, {once:true});
            e.target.addEventListener('mouseleave', cancelPress, {once:true});
            e.target.addEventListener('touchend', cancelPress, {once:true});
            e.target.addEventListener('touchmove', cancelPress, {once:true});
        }

        function handleClick(e) {
            // ç¼–è¾‘æ¨¡å¼ä¸‹ï¼šé˜»æ­¢ç‚¹å‡»ï¼Œä½†ä¸å½±å“æ‹–æ‹½
            if (isEditMode) {
                e.preventDefault();
                e.stopPropagation();
                return;
            }
            
            // æ‰¾åˆ°å¯¹åº”çš„ App åå­—
            const appName = e.currentTarget.getAttribute('data-app');
            if (appName) openApp(appName);
        }

        // 3. è¿›å…¥ç¼–è¾‘æ¨¡å¼
        function enterEditMode() {
            if (isEditMode) return;
            isEditMode = true;

            // ä¿å­˜å½“å‰çŠ¶æ€ä»¥ä¾¿å–æ¶ˆ
            originalOrderHTML = gridContainer.innerHTML;

            // UI å˜åŒ–
            document.body.classList.add('is-editing');
            document.getElementById('edit-controls').classList.add('active');
            
            getAppItems().forEach(item => {
                item.classList.add('editing');
                
                // æ¡Œé¢ç«¯ï¼šä½¿ç”¨ HTML5 Drag & Drop API
                if (!isTouchDevice) {
                    item.setAttribute('draggable', 'true');
                    // ä¸´æ—¶ç§»é™¤ click äº‹ä»¶ï¼Œé¿å…å¹²æ‰°æ‹–æ‹½
                    item.removeEventListener('click', handleClick);
                }
                
                // ç§»åŠ¨ç«¯ï¼šç»‘å®šè§¦æ‘¸æ‹–æ‹½äº‹ä»¶ï¼ˆä½¿ç”¨ capture ç¡®ä¿ä¼˜å…ˆå¤„ç†ï¼‰
                if (isTouchDevice) {
                    item.addEventListener('touchstart', handleTouchStart, {passive: false, capture: true});
                    item.addEventListener('touchmove', handleTouchMove, {passive: false, capture: true});
                    item.addEventListener('touchend', handleTouchEnd, {passive: false, capture: true});
                }
            });
        }

        // 4. é€€å‡ºç¼–è¾‘æ¨¡å¼ (ä¿å­˜æˆ–å–æ¶ˆ)
        function closeEditMode() {
            isEditMode = false;
            document.body.classList.remove('is-editing');
            document.getElementById('edit-controls').classList.remove('active');
            
            getAppItems().forEach(item => {
                item.classList.remove('editing');
                item.classList.remove('dragging');
                
                // æ¡Œé¢ç«¯ï¼šç¦ç”¨ HTML5 Drag & Dropï¼Œæ¢å¤ click äº‹ä»¶
                if (!isTouchDevice) {
                    item.setAttribute('draggable', 'false');
                    // æ¢å¤ click äº‹ä»¶
                    item.addEventListener('click', handleClick);
                }
                
                // ç§»åŠ¨ç«¯ï¼šç§»é™¤è§¦æ‘¸æ‹–æ‹½äº‹ä»¶
                if (isTouchDevice) {
                    item.removeEventListener('touchstart', handleTouchStart, {capture: true});
                    item.removeEventListener('touchmove', handleTouchMove, {capture: true});
                    item.removeEventListener('touchend', handleTouchEnd, {capture: true});
                }
            });
            
            // æ¸…ç†æ‹–æ‹½çŠ¶æ€
            draggedItem = null;
            touchDraggedItem = null;
            
            // é‡æ–°ç»‘å®šäº‹ä»¶ä»¥é˜² DOM å˜åŠ¨å¯¼è‡´ä¸¢å¤±
            initDesktopIcons();
        }

        function saveEditMode() {
            // è·å–å½“å‰é¡ºåº
            const order = Array.from(getAppItems()).map(item => item.getAttribute('data-app'));
            AppStorage.set('desktop_layout', order);
            
            closeEditMode();
            showInfo("å¸ƒå±€å·²ä¿å­˜", 'success');
        }

        function cancelEditMode() {
            // æ¢å¤åŸæ¥çš„ HTML
            gridContainer.innerHTML = originalOrderHTML;
            closeEditMode();
        }

        function resetDesktopLayout() {
            // ç¡®è®¤é‡ç½®
            if (typeof window.showConfirm === 'function') {
                window.showConfirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤å¸ƒå±€å—ï¼Ÿ', () => {
                    // ç§»é™¤ä¿å­˜çš„å¸ƒå±€
                    localStorage.removeItem('desktop_layout');
                    // é‡æ–°åŠ è½½é¡µé¢
                    location.reload();
                }, 'é‡ç½®');
            } else {
                if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤å¸ƒå±€å—ï¼Ÿ')) {
                    localStorage.removeItem('desktop_layout');
                    location.reload();
                }
            }
        }

        // 5. æ‹–æ‹½æ’åºé€»è¾‘
        let draggedItem = null;
        
        // æ£€æµ‹æ˜¯å¦ä¸ºè§¦æ‘¸è®¾å¤‡
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        // ===== æ¡Œé¢ç«¯ï¼šHTML5 Drag & Drop API =====
        function handleDragStart(e) {
            if (!isEditMode) return;
            
            // é˜»æ­¢ç‚¹å‡»äº‹ä»¶ï¼Œé¿å…æ‹–æ‹½æ—¶è§¦å‘ç‚¹å‡»
            e.stopPropagation();
            
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            // æŸäº›æµè§ˆå™¨éœ€è¦è®¾ç½® data æ‰èƒ½æ‹–æ‹½
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (!isEditMode || !draggedItem) return;
            e.preventDefault(); // å¿…é¡»é˜»æ­¢é»˜è®¤è¡Œä¸ºæ‰èƒ½ Drop
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            e.dataTransfer.dropEffect = 'move';

            // æ ¸å¿ƒæ’åºé€»è¾‘ï¼šå¦‚æœæ‹–åˆ°äº†åˆ«çš„å›¾æ ‡ä¸Šé¢ï¼Œå°±äº¤æ¢ä½ç½®
            const target = e.target.closest('.app-item');
            if (target && target !== draggedItem) {
                swapItems(draggedItem, target);
            }
        }
        
        function handleDragEnd(e) {
            // é˜»æ­¢æ‹–æ‹½ç»“æŸåçš„ç‚¹å‡»äº‹ä»¶
            e.stopPropagation();
            this.classList.remove('dragging');
            draggedItem = null;
        }

        function handleDrop(e) {
            e.stopPropagation(); // é˜²æ­¢æµè§ˆå™¨æ‰“å¼€é“¾æ¥ç­‰
            return false;
        }

        // ===== ç§»åŠ¨ç«¯ï¼šè§¦æ‘¸æ‹–æ‹½å®ç° =====
        let touchStartY = 0;
        let touchStartX = 0;
        let touchDraggedItem = null;
        let touchStartElement = null;
        let touchMoveThreshold = 10; // ç§»åŠ¨é˜ˆå€¼ï¼Œé¿å…è¯¯è§¦
        let isDragging = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨æ‹–æ‹½

        function handleTouchStart(e) {
            if (!isEditMode) return;
            
            const touch = e.touches[0];
            touchStartY = touch.clientY;
            touchStartX = touch.clientX;
            touchStartElement = e.target.closest('.app-item');
            
            if (!touchStartElement) return;
            
            // é˜»æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶ä¼ æ’­
            e.preventDefault();
            e.stopPropagation();
            
            touchDraggedItem = touchStartElement;
            isDragging = false; // é‡ç½®æ‹–æ‹½çŠ¶æ€
            
            // éœ‡åŠ¨åé¦ˆ
            if (navigator.vibrate) navigator.vibrate(30);
        }

        function handleTouchMove(e) {
            if (!isEditMode || !touchDraggedItem) return;
            
            const touch = e.touches[0];
            const deltaY = Math.abs(touch.clientY - touchStartY);
            const deltaX = Math.abs(touch.clientX - touchStartX);
            
            // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡é˜ˆå€¼ï¼Œæ‰å¼€å§‹æ‹–æ‹½
            if (!isDragging && (deltaY < touchMoveThreshold && deltaX < touchMoveThreshold)) {
                return;
            }
            
            // æ ‡è®°ä¸ºæ­£åœ¨æ‹–æ‹½
            if (!isDragging) {
                isDragging = true;
                touchDraggedItem.classList.add('dragging');
            }
            
            e.preventDefault(); // é˜»æ­¢é¡µé¢æ»šåŠ¨
            e.stopPropagation();
            
            // è·å–è§¦æ‘¸ç‚¹ä¸‹çš„å…ƒç´ 
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const target = elementBelow ? elementBelow.closest('.app-item') : null;
            
            if (target && target !== touchDraggedItem) {
                swapItems(touchDraggedItem, target);
                // æ›´æ–°èµ·å§‹ä½ç½®ï¼Œé¿å…é‡å¤äº¤æ¢
                touchStartY = touch.clientY;
                touchStartX = touch.clientX;
            }
        }

        function handleTouchEnd(e) {
            if (!isEditMode) return;
            
            if (touchDraggedItem) {
                touchDraggedItem.classList.remove('dragging');
            }
            
            touchDraggedItem = null;
            touchStartElement = null;
            isDragging = false;
        }

        // é€šç”¨çš„äº¤æ¢ä½ç½®å‡½æ•°ï¼ˆæ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯å…±ç”¨ï¼‰
        function swapItems(dragged, target) {
            const items = Array.from(gridContainer.children);
            const curIndex = items.indexOf(dragged);
            const targetIndex = items.indexOf(target);

            if (curIndex < targetIndex) {
                gridContainer.insertBefore(dragged, target.nextSibling);
            } else {
                gridContainer.insertBefore(dragged, target);
            }
        }
        // --- å¯åŠ¨åˆå§‹åŒ– ---
        setTimeout(initDesktopIcons, 100); 
    </script>
    <script src="others/tutorial.js"></script>
    <script src="others/pendant.js"></script>
    <script src="settings/appearance.js"></script>
    <script src="settings/api.js"></script>
    <script src="others/dynamicIsland.js"></script> 
</body>
</html>
